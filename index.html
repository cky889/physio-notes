<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CMS Clinical V24.1</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojMmMzZTUwIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzJjM2U1MCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxODAiIGZpbGw9IndoaXRlIiBmb250LXdlaWdodD0iYm9sZCI+VjI0PC90ZXh0Pjwvc3ZnPg==">
    <style>
        :root { --main: #2c3e50; --acc: #2980b9; --bg: #f3f4f6; --warn: #f59e0b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: #1f2937; -webkit-tap-highlight-color: transparent; }
        
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.3s; }
        .auth-card { background: white; color: #333; width: 85%; max-width: 320px; padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .auth-input { width: 100%; padding: 14px; margin: 8px 0; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1.1rem; text-align: center; background: #fff; appearance: none; -webkit-appearance: none; }
        .auth-btn { width: 100%; padding: 16px; background: var(--acc); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .auth-btn.sec { background: white; color: var(--acc); border: 2px solid var(--acc); margin-top: 12px; }
        .hidden { display: none !important; }

        header { background: var(--main); color: white; padding: 12px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.9rem; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-weight: bold; }
        .tab-bar { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 4px; }
        .tab-btn { padding: 8px 16px; background: rgba(255,255,255,0.15); border-radius: 20px; color: #ddd; font-size: 0.9rem; white-space: nowrap; cursor: pointer; user-select: none; -webkit-user-select: none; }
        .tab-btn.active { background: white; color: var(--main); font-weight: 800; transform: scale(1.05); }
        .tab-btn.add { background: var(--acc); color: white; font-weight: bold; }

        .import-btn { background: var(--warn); color: #fff; border:none; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; cursor: pointer; }

        .container { max-width: 700px; margin: 0 auto; padding: 12px; }
        .patient-view { display: none; }
        .patient-view.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .head-sec { font-size: 0.8rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #f3f4f6; padding-bottom: 5px; }
        
        .ref-box { background: #fffbeb; border: 2px dashed #fcd34d; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .ref-box.show { display: block; }
        .ref-title { font-weight: 800; color: #b45309; font-size: 0.85rem; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .ref-content { font-size: 0.85rem; color: #78350f; white-space: pre-wrap; max-height: 150px; overflow-y: auto; font-family: monospace; line-height: 1.3; }

        input, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; margin-bottom: 12px; -webkit-appearance: none; }
        
        select {
            width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px;
            background-color: #fff; color: #1f2937;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%232980b9%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 12px top 50%;
            background-size: 10px auto;
            padding-right: 30px;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .accordion { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
        .accordion-head { padding: 12px 15px; background: #f9fafb; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-body { display: none; padding: 15px; background: white; border-top: 1px solid #e5e7eb; }
        .accordion-body.show { display: block; }
        
        .rom-row { margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; }
        .rom-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .rom-title { font-size: 0.9rem; font-weight: 800; color: #333; }
        .manual-input { width: 80px; padding: 6px; margin-bottom: 0; font-size: 0.85rem; height: 32px; text-align: right; border: 1px solid #ccc; }
        .btn-grid { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
        .rom-btn { padding: 8px 12px; font-size: 0.8rem; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; color: #555; cursor: pointer; }
        .rom-btn.range.selected { background: #e0f2fe; color: #0284c7; border-color: #0284c7; font-weight: 700; }
        .rom-btn.quality.selected { background: #fef2f2; color: #dc2626; border-color: #dc2626; font-weight: 700; }
        
        .chk-list { display: flex; flex-direction: column; gap: 8px; margin-top: 5px;}
        .chk-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; background: #fff; border: 1px solid #d1d5db; border-radius: 8px;
            cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent;
            font-size: 1rem; color: #374151;
        }
        .chk-item input { display: none; } 
        .chk-item.active { background: #eff6ff; border-color: var(--acc); color: var(--acc); font-weight: 600; }
        .chk-item::after {
            content: 'âœ“'; font-weight: 900; color: var(--acc);
            opacity: 0; transform: scale(0.5); transition: all 0.2s;
        }
        .chk-item.active::after { opacity: 1; transform: scale(1.2); }

        .special-row { display: grid; grid-template-columns: 1fr 100px; gap: 10px; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #e5e7eb; padding-bottom: 8px; }
        .special-row input { margin-bottom: 0; font-size: 0.9rem; }
        .special-row select { margin-bottom: 0; padding: 8px; font-weight: bold; }
        .special-label { font-size: 0.9rem; font-weight: 600; color: #444; margin-bottom: 4px; display: block; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal.open { display: flex; }
        .modal-card { background: white; width: 90%; max-width: 500px; border-radius: 12px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

        .fab { position: fixed; bottom: 30px; left: 20px; right: 20px; background: var(--acc); color: white; padding: 16px; border-radius: 50px; font-size: 1.1rem; font-weight: 700; border: none; box-shadow: 0 4px 15px rgba(41,128,185,0.4); z-index: 1000; cursor: pointer; display:flex; justify-content:center; align-items:center; gap:10px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div id="view-login" class="auth-card">
        <h3>CMS Clinical V24.1</h3>
        <select id="user-select" class="auth-input"></select>
        <input type="tel" id="user-pin" class="auth-input" placeholder="PIN" maxlength="6" style="-webkit-text-security:disc;">
        <button class="auth-btn" onclick="attemptLogin()">Unlock App</button>
        <button class="auth-btn sec" onclick="toggleAuth('register')">Create New Profile</button>
    </div>
    <div id="view-register" class="auth-card hidden">
        <h3>Create Profile</h3>
        <input type="text" id="reg-name" class="auth-input" placeholder="Your Name">
        <input type="tel" id="reg-pin" class="auth-input" placeholder="Create PIN (4 digits)" maxlength="6">
        <button class="auth-btn" style="background:#10b981;" onclick="registerUser()">Start Using App</button>
        <button class="auth-btn sec" style="color:#666; border-color:#ccc;" onclick="toggleAuth('login')">Back</button>
    </div>
</div>

<div id="app-ui" style="display:none;">
    <header>
        <div class="top-row">
            <div class="user-badge" id="display-name">Guest</div>
            <button class="import-btn" onclick="openImport()">Import CMS</button>
            <div style="color:#fca5a5; cursor:pointer;" onclick="logout()">Lock ðŸ”’</div>
        </div>
        <div class="tab-bar" id="tab-bar">
            <div class="tab-btn add" onclick="addPatient()">+ Pt</div>
        </div>
    </header>

    <div class="container" id="patients-container"></div>
    <button class="fab" onclick="generateNote()">COPY CMS NOTE</button>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal">
    <div class="modal-card">
        <h3>Import CMS Note</h3>
        <p style="font-size:0.9rem; color:#666;">Paste the full text from your previous session/HA Chat. The app will fill the forms and keep the text for reference.</p>
        <textarea id="import-text" style="height:150px; font-family:monospace; font-size:0.8rem;" placeholder="Paste text here..."></textarea>
        <button class="auth-btn" onclick="parseAndImport()">Import & Parse</button>
        <button class="auth-btn sec" onclick="document.getElementById('import-modal').classList.remove('open')">Cancel</button>
    </div>
</div>

<textarea id="copy_target" style="opacity:0; height:1px; position:absolute; bottom:0;"></textarea>

<template id="patient-template">
    <div class="patient-view">
        <div class="ref-box">
            <div class="ref-title"><span>OLD NOTE REFERENCE</span> <span onclick="this.parentElement.parentElement.classList.remove('show')" style="cursor:pointer">âœ•</span></div>
            <div class="ref-content"></div>
        </div>

        <div class="card" style="border:2px solid #2980b9; background:#f0f9ff;">
            <div class="head-sec" style="color:#2980b9;">Admin Data</div>
            <input type="text" class="pt-id" placeholder="Bed / Ref" onkeyup="saveWork(); updateTabName(this)" style="font-weight:bold; font-size:1.1rem; margin-bottom:0;">
            <div class="grid-2">
                <input class="dx" placeholder="Diagnosis" onkeyup="saveWork()">
                <input class="ref" placeholder="Reason for Referral" onkeyup="saveWork()">
            </div>
        </div>
        
        <div class="card">
            <div class="head-sec">History</div>
            <textarea class="hpi" style="height:60px" placeholder="HPI" onkeyup="saveWork()"></textarea>
            <textarea class="pmh" style="height:50px" placeholder="PMH" onkeyup="saveWork()"></textarea>
            <textarea class="meds" style="height:50px" placeholder="Medication" onkeyup="saveWork()"></textarea>
            <input class="fall" placeholder="Fall History & Reason" onkeyup="saveWork()">
            <input class="ment" placeholder="Mental Status" onkeyup="saveWork()">
            <input class="prev_pt" placeholder="Prev PT (Default: NIL)" value="NIL" onkeyup="saveWork()">
        </div>

        <div class="card">
            <div class="head-sec">Social / Env</div>
            <div class="grid-2">
                <select class="soc_live" onchange="saveWork()"><option value="">Lives with...</option><option value="Spouse">Spouse</option><option value="Maid">Maid</option><option value="Daughter">Daughter</option><option value="Son">Son</option><option value="Alone">Alone</option></select>
                <select class="soc_carer" onchange="saveWork()"><option value="">Carer...</option><option value="Spouse">Spouse</option><option value="Maid">Maid</option><option value="Daughter">Daughter</option><option value="Son">Son</option><option value="Self">Self</option></select>
            </div>
            <div class="grid-2">
                <input class="soc_pre" placeholder="Premorbid" onkeyup="saveWork()">
                <select class="env_type" onchange="saveWork()">
                    <option value="" disabled selected>Housing Type</option>
                    <option value="Public housing">Public Housing</option>
                    <option value="Private housing">Private Housing</option>
                    <option value="Village house">Village House</option>
                </select>
            </div>
            <div class="grid-2">
                <select class="env_acc" onchange="toggleStairs(this); saveWork()">
                    <option value="Lift-landing">Lift-landing</option>
                    <option value="Stairs">Stairs</option>
                </select>
                <input class="env_stairs_txt hidden" placeholder="No. of Steps (e.g. 5)" onkeyup="saveWork()">
            </div>
            <div class="grid-2">
                <select class="env_wc" onchange="saveWork()">
                    <option value="" disabled selected>Toilet Type</option>
                    <option value="Sitting">WC: Sitting</option>
                    <option value="Squatting">WC: Squatting</option>
                    <option value="Commode">WC: Commode</option>
                </select>
                <select class="env_bath" onchange="saveWork()">
                    <option value="" disabled selected>Bath Type</option>
                    <option value="Sitting">Bath: Sitting</option>
                    <option value="Shower cubicle">Bath: Shower</option>
                    <option value="Bath tub">Bath: Tub</option>
                </select>
            </div>
            
            <div style="margin-top:10px;">
                <div class="chk-item env_rails_row" onclick="toggleChk(this)">
                    <input type="checkbox" class="env_rails">
                    <span>Handrails available</span>
                </div>
            </div>
            
            <input class="env_note" placeholder="Env Note (Default: Spaceous...)" value="Spaceous and tidy" onkeyup="saveWork()" style="margin-top:12px;">
        </div>
        
        <div class="card">
            <div class="head-sec">Objective</div>
            <input class="subj" placeholder="Subjective (Compliant)" value="Compliant" onkeyup="saveWork()">
            <input class="func" placeholder="Func Limit (e.g. Prolonged walk)" onkeyup="saveWork()">
            <input class="ass_with" placeholder="Assessed with (e.g. Maid)" onkeyup="saveWork()">
            <div class="grid-2">
                <input class="bp" placeholder="BP" onkeyup="saveWork()">
                <input class="hr" placeholder="HR" onkeyup="saveWork()">
            </div>
            <input class="obs" placeholder="Observation" value="Thin body build" onkeyup="saveWork()">
            <div class="body-container"></div>
            <div style="margin-top:20px; font-weight:700; color:#555;">Power (Right / Left)</div>
            <div style="background:#f9f9f9; padding:10px; border-radius:8px;">
                <div class="grid-2">
                    <input class="pwr_ul" placeholder="UL (e.g. 5 / 5)" onkeyup="saveWork()">
                    <input class="pwr_ll" placeholder="LL (e.g. 4 / 4)" onkeyup="saveWork()">
                </div>
            </div>
        </div>
        <div class="card">
            <div class="head-sec">Plan</div>
            <div class="grid-2">
                <input class="bed" placeholder="Bed Mob" onkeyup="saveWork()">
                <input class="tf" placeholder="Transfer" onkeyup="saveWork()">
            </div>
            <input class="gait" placeholder="Gait" onkeyup="saveWork()">
            <input class="prob" placeholder="Problem" onkeyup="saveWork()">
            <div class="grid-2">
                <input class="stg" placeholder="STG" onkeyup="saveWork()">
                <input class="ltg" placeholder="LTG" onkeyup="saveWork()">
            </div>
            <div style="margin-top:10px; font-weight:bold; color:#2980b9;">Exercises Taught:</div>
            <div class="chk-list ex-list"></div>
            <textarea class="ex-free" placeholder="Other exercises / specific parameters..." style="height:60px; margin-top:12px;" onkeyup="saveWork()"></textarea>
        </div>
    </div>
</template>

<script>
    const USERS_KEY = 'physio_users_v1';
    let currentUser = null;
    let currentPatients = [];
    let currentTab = 0;
    
    // FULL NOTE TITLES ADDED
    const bodyParts = [
        {name:"Neck (Cervical)", noteTitle: "Active range of movement of neck", id:"cx", mov:["Flex","Ext","Rot(L)","Rot(R)","Side(L)","Side(R)"], tests:["Spurling","Distraction"], palp:["Trapezius","Levator"]},
        {name:"Back (Lumbar)", noteTitle: "Active range of movement of back", id:"lx", mov:["Flex","Ext","Rot(L)","Rot(R)","Side(L)","Side(R)"], tests:["SLR","Slump"], palp:["Paraspinals","PSIS"]},
        {name:"Shoulder(R)", noteTitle: "Active range of movement of right shoulder", id:"sr", mov:["Flex","Abd","ExtRot","IntRot","HBB"], tests:["Neer","Hawkins","Empty Can"], palp:["ACJ","Supraspinatus"]},
        {name:"Shoulder(L)", noteTitle: "Active range of movement of left shoulder", id:"sl", mov:["Flex","Abd","ExtRot","IntRot","HBB"], tests:["Neer","Hawkins","Empty Can"], palp:["ACJ","Supraspinatus"]},
        {name:"Knee(R)", noteTitle: "Active range of movement of right knee", id:"kr", mov:["Flex","Ext"], tests:["McMurray","Lachman","Varus/Valgus"], palp:["Joint Line","Patella"]},
        {name:"Knee(L)", noteTitle: "Active range of movement of left knee", id:"kl", mov:["Flex","Ext"], tests:["McMurray","Lachman","Varus/Valgus"], palp:["Joint Line","Patella"]},
        {name:"Ankle(R)", noteTitle: "Active range of movement of right ankle", id:"ar", mov:["DF","PF","Inv","Eve"], tests:["Talar Tilt","Drawer"], palp:["ATFL","Med Mall"]},
        {name:"Ankle(L)", noteTitle: "Active range of movement of left ankle", id:"al", mov:["DF","PF","Inv","Eve"], tests:["Talar Tilt","Drawer"], palp:["ATFL","Med Mall"]}
    ];
    
    const movMap = {
        "Flex": "flexion", "Ext": "extension", 
        "Rot(L)": "left rotation", "Rot(R)": "right rotation",
        "Side(L)": "left side flexion", "Side(R)": "right side flexion",
        "Abd": "abduction", "ExtRot": "external rotation", "IntRot": "internal rotation", "HBB": "hand behind back",
        "DF": "dorsiflexion", "PF": "plantarflexion", "Inv": "inversion", "Eve": "eversion"
    };

    const exercises = [
        "resisted Biceps flexion exercise in sitting",
        "resisted Knee extension exercise in sitting",
        "resisted Hip abduction exercise in sitting",
        "LL elevation",
        "active ankle and toes exercise",
        "self-stretching over right hamstrings muscles",
        "active knee mobilization in sitting",
        "Walking exercise with stick",
        "Gait correction",
        "Sit to stand training",
        "Fall prevention reinforced",
        "Exercise precautions reinforced",
        "OA knee care reinforced",
        "carer skills reinforced",
        "Suggested to have bathing in sitting position for fall prevention",
        "Encouraged to increase the frequency of walking exercise in the corridor",
        "Encouraged patient's wife to tidy up home and remove obstacles"
    ];

    window.onload = loadUsersDropdown;

    function loadUsersDropdown() {
        let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        let validKeys = Object.keys(users).filter(k => k && k.trim() !== "");
        const sel = document.getElementById('user-select');
        if (validKeys.length === 0) {
            sel.innerHTML = '<option value="" disabled selected>No users found</option>';
            toggleAuth('register');
        } else {
            sel.innerHTML = '<option value="" disabled selected>Select User</option>';
            validKeys.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        }
    }

    function toggleAuth(m) {
        document.getElementById('view-login').classList.toggle('hidden', m !== 'login');
        document.getElementById('view-register').classList.toggle('hidden', m !== 'register');
    }

    function registerUser() {
        const n = document.getElementById('reg-name').value.trim();
        const p = document.getElementById('reg-pin').value.trim();
        if(!n || p.length < 4) return alert("Enter Name & 4-digit PIN");
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        users[n] = p;
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        currentUser = n;
        document.getElementById('display-name').innerText = n;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-ui').style.display = 'block';
        loadWorkspace();
    }

    function attemptLogin() {
        const n = document.getElementById('user-select').value;
        const p = document.getElementById('user-pin').value;
        if(!n) return alert("Select user");
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
        if(users[n] == p) {
            currentUser = n;
            document.getElementById('display-name').innerText = n;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            loadWorkspace();
        } else alert("Invalid PIN");
    }

    function logout() { location.reload(); }

    function loadWorkspace() {
        const raw = localStorage.getItem(`physio_data_${currentUser}`);
        currentPatients = raw ? JSON.parse(raw) : [];
        if(currentPatients.length === 0) createPatientData();
        renderAll();
    }

    function saveWork() {
        const view = document.getElementById(`view-${currentTab}`);
        if(!view) return;
        const pt = currentPatients[currentTab];
        pt.id = view.querySelector('.pt-id').value;
        pt.dx = view.querySelector('.dx').value;
        pt.ref = view.querySelector('.ref').value;
        pt.hpi = view.querySelector('.hpi').value;
        pt.pmh = view.querySelector('.pmh').value;
        pt.meds = view.querySelector('.meds').value;
        pt.fall = view.querySelector('.fall').value;
        pt.ment = view.querySelector('.ment').value;
        pt.prev = view.querySelector('.prev_pt').value;
        
        pt.soc = {
            live: view.querySelector('.soc_live').value,
            carer: view.querySelector('.soc_carer').value,
            pre: view.querySelector('.soc_pre').value,
            acc: view.querySelector('.env_acc').value,
            stairs: view.querySelector('.env_stairs_txt').value,
            wc: view.querySelector('.env_wc').value,
            type: view.querySelector('.env_type').value,
            bath: view.querySelector('.env_bath').value,
            rails: view.querySelector('.env_rails').checked,
            note: view.querySelector('.env_note').value
        };
        pt.assess = {
            subj: view.querySelector('.subj').value,
            func: view.querySelector('.func').value,
            ass_with: view.querySelector('.ass_with').value,
            bp: view.querySelector('.bp').value,
            hr: view.querySelector('.hr').value,
            obs: view.querySelector('.obs').value,
            pul: view.querySelector('.pwr_ul').value,
            pll: view.querySelector('.pwr_ll').value
        };
        pt.plan = {
            bed: view.querySelector('.bed').value,
            tf: view.querySelector('.tf').value,
            gait: view.querySelector('.gait').value,
            prob: view.querySelector('.prob').value,
            stg: view.querySelector('.stg').value,
            ltg: view.querySelector('.ltg').value
        };
        
        pt.roms = {};
        view.querySelectorAll('.rom-row').forEach(r => {
            const uid = r.dataset.uid;
            const man = r.querySelector('.manual-input')?.value;
            const ran = r.querySelector('.range.selected')?.innerText;
            const qua = Array.from(r.querySelectorAll('.quality.selected')).map(b=>b.innerText).join(',');
            const splTxt = r.querySelector('.special-txt')?.value;
            const splSel = r.querySelector('.special-sel')?.value;
            
            if(man !== undefined) pt.roms[uid] = {m:man, r:ran||"", q:qua};
            else if(splSel) pt.roms[uid] = {txt: splTxt, res: splSel}; 
        });
        pt.ex = Array.from(view.querySelectorAll('.ex-list input:checked')).map(c=>c.value);
        pt.ex_free = view.querySelector('.ex-free').value;
        
        localStorage.setItem(`physio_data_${currentUser}`, JSON.stringify(currentPatients));
    }

    function createPatientData() {
        currentPatients.push({ id:"", hpi:"", soc:{}, assess:{}, plan:{}, roms:{}, ex:[] });
        renderAll(); switchTab(currentPatients.length - 1);
    }
    
    function addPatient() { saveWork(); createPatientData(); }
    
    function deletePatient(idx) {
        if(currentPatients.length <= 1) return alert("Cannot delete the last patient.");
        if(confirm("Delete this patient? This cannot be undone.")) {
            currentPatients.splice(idx, 1);
            localStorage.setItem(`physio_data_${currentUser}`, JSON.stringify(currentPatients));
            currentTab = Math.max(0, idx - 1); // Move to previous tab
            renderAll();
        }
    }

    function openImport() {
        document.getElementById('import-text').value = '';
        document.getElementById('import-modal').classList.add('open');
    }

    function parseAndImport() {
        const text = document.getElementById('import-text').value;
        if(!text.trim()) return alert("No text entered.");
        
        // Use current tab
        const pt = currentPatients[currentTab];
        
        // Helper regex
        const find = (regex) => { const m = text.match(regex); return m ? m[1].trim() : ""; }
        const findBlock = (start, end) => {
            const idx1 = text.indexOf(start);
            if(idx1 === -1) return "";
            const sub = text.substring(idx1 + start.length);
            const idx2 = end ? sub.indexOf(end) : sub.length;
            return idx2 === -1 ? sub.trim() : sub.substring(0, idx2).trim();
        }

        // --- Parsing Logic ---
        if(!pt.dx) pt.dx = find(/Diagnosis: (.*)/);
        if(!pt.ref) pt.ref = find(/Reason for referral: (.*)/);
        
        pt.hpi = findBlock("History of Present Illness:", "Past Medical History:");
        pt.pmh = findBlock("Past Medical History:", "Medication:");
        pt.meds = findBlock("Medication:", "Social History:");
        
        // Social
        const socBlock = findBlock("Social History:", "Home Environment:");
        if(socBlock.includes("Spouse")) pt.soc.live = "Spouse";
        else if(socBlock.includes("Maid")) pt.soc.live = "Maid";
        else if(socBlock.includes("Son")) pt.soc.live = "Son";
        else if(socBlock.includes("Daughter")) pt.soc.live = "Daughter";
        else if(socBlock.includes("Alone")) pt.soc.live = "Alone";

        // Vitals
        const bp = find(/Blood Pressure (.*) mmHg/);
        if(bp) pt.assess.bp = bp;
        const hr = find(/Pulse (.*) bpm/);
        if(hr) pt.assess.hr = hr;

        // Store Full Text for Reference
        pt.refText = text;

        // Save & Render
        document.getElementById('import-modal').classList.remove('open');
        localStorage.setItem(`physio_data_${currentUser}`, JSON.stringify(currentPatients));
        renderAll();
        alert("Imported! Admin, History, and Vitals have been filled. Check the yellow box for the original note.");
    }

    function renderAll() {
        const cont = document.getElementById('patients-container');
        const bar = document.getElementById('tab-bar');
        cont.innerHTML = '';
        Array.from(bar.children).forEach(c => { if(!c.classList.contains('add')) c.remove(); });
        
        currentPatients.forEach((pt, idx) => {
            const btn = document.createElement('div');
            btn.className = `tab-btn ${idx === currentTab ? 'active' : ''}`;
            btn.innerText = pt.id || `Pt ${idx+1}`;
            
            btn.onclick = () => switchTab(idx);
            let timer;
            btn.addEventListener('touchstart', () => { timer = setTimeout(() => deletePatient(idx), 800); });
            btn.addEventListener('touchend', () => clearTimeout(timer));
            btn.addEventListener('touchmove', () => clearTimeout(timer));

            bar.insertBefore(btn, bar.lastElementChild);
            
            const clone = document.getElementById('patient-template').content.cloneNode(true);
            const view = clone.querySelector('.patient-view');
            view.id = `view-${idx}`;
            if(idx === currentTab) view.classList.add('active');
            
            // Reference Box Logic
            const refBox = view.querySelector('.ref-box');
            if(pt.refText) {
                refBox.classList.add('show');
                refBox.querySelector('.ref-content').innerText = pt.refText;
            }

            view.querySelector('.pt-id').value = pt.id || "";
            view.querySelector('.dx').value = pt.dx || "";
            view.querySelector('.ref').value = pt.ref || "";
            view.querySelector('.hpi').value = pt.hpi || "";
            view.querySelector('.pmh').value = pt.pmh || "";
            view.querySelector('.meds').value = pt.meds || "";
            view.querySelector('.fall').value = pt.fall || "";
            view.querySelector('.ment').value = pt.ment || "";
            view.querySelector('.prev_pt').value = pt.prev || "NIL";
            
            if(pt.soc) {
                view.querySelector('.soc_live').value = pt.soc.live || "";
                view.querySelector('.soc_carer').value = pt.soc.carer || "";
                view.querySelector('.soc_pre').value = pt.soc.pre || "";
                view.querySelector('.env_acc').value = pt.soc.acc || "Lift-landing";
                view.querySelector('.env_stairs_txt').value = pt.soc.stairs || "";
                view.querySelector('.env_wc').value = pt.soc.wc || "";
                view.querySelector('.env_type').value = pt.soc.type || "";
                view.querySelector('.env_bath').value = pt.soc.bath || "";
                view.querySelector('.env_note').value = pt.soc.note || "Spaceous and tidy";
                
                const railsChk = view.querySelector('.env_rails');
                const railsRow = view.querySelector('.env_rails_row');
                railsChk.checked = pt.soc.rails || false;
                if(railsChk.checked) railsRow.classList.add('active');
                
                toggleStairs(view.querySelector('.env_acc'));
            }
            if(pt.assess) {
                view.querySelector('.subj').value = pt.assess.subj || "Compliant";
                view.querySelector('.func').value = pt.assess.func || "";
                view.querySelector('.ass_with').value = pt.assess.ass_with || "";
                view.querySelector('.bp').value = pt.assess.bp || "";
                view.querySelector('.hr').value = pt.assess.hr || "";
                view.querySelector('.obs').value = pt.assess.obs || "Thin body build";
                view.querySelector('.pwr_ul').value = pt.assess.pul || "";
                view.querySelector('.pwr_ll').value = pt.assess.pll || "";
            }
            if(pt.plan) {
                view.querySelector('.bed').value = pt.plan.bed || "";
                view.querySelector('.tf').value = pt.plan.tf || "";
                view.querySelector('.gait').value = pt.plan.gait || "";
                view.querySelector('.prob').value = pt.plan.prob || "";
                view.querySelector('.stg').value = pt.plan.stg || "";
                view.querySelector('.ltg').value = pt.plan.ltg || "";
            }
            
            const bc = view.querySelector('.body-container');
            bodyParts.forEach(bp => {
                let html = `<div class="accordion"><div class="accordion-head" onclick="toggleAc(this)">${bp.name} <span>+</span></div><div class="accordion-body">`;
                
                bp.mov.forEach(m => {
                    const uid = `${bp.id}_${m}`;
                    const d = pt.roms[uid] || {m:"",r:"",q:""};
                    const rs = (t) => d.r===t ? 'selected' : '';
                    const qs = (t) => d.q.includes(t) ? 'selected' : '';
                    html += `<div class="rom-row" data-uid="${uid}">
                        <div class="rom-header"><div class="rom-title">${m}</div><input class="manual-input" value="${d.m}" onkeyup="saveWork()"></div>
                        <div class="btn-grid"><div class="rom-btn range ${rs('Full')}" onclick="sel(this);saveWork()">Full</div><div class="rom-btn range ${rs('limited')}" onclick="sel(this);saveWork()">limited</div></div>
                        <div class="btn-grid"><div class="rom-btn quality ${qs('Pain')}" onclick="tog(this);saveWork()">Pain</div></div>
                    </div>`;
                });

                if(bp.tests) {
                    bp.tests.forEach(test => {
                        const uid = `${bp.id}_test_${test}`;
                        const d = pt.roms[uid] || {txt:"", res:"-ve"};
                        html += `<div class="rom-row special-row" data-uid="${uid}">
                                <div>
                                    <span class="special-label">${test}</span>
                                    <input class="special-txt" placeholder="Note (optional)" value="${d.txt}" onkeyup="saveWork()">
                                </div>
                                <select class="special-sel" onchange="saveWork()" style="color:${d.res==='+ve'?'red':'green'}">
                                    <option value="-ve" ${d.res==='-ve'?'selected':''}>-ve</option>
                                    <option value="+ve" ${d.res==='+ve'?'selected':''}>+ve</option>
                                </select>
                            </div>`;
                    });
                }

                if(bp.palp) {
                    bp.palp.forEach(palp => {
                        const uid = `${bp.id}_palp_${palp}`;
                        const d = pt.roms[uid] || {txt:"", res:"-ve"};
                        html += `<div class="rom-row special-row" data-uid="${uid}">
                                <div>
                                    <span class="special-label">${palp}</span>
                                    <input class="special-txt" placeholder="Note (optional)" value="${d.txt}" onkeyup="saveWork()">
                                </div>
                                <select class="special-sel" onchange="saveWork()" style="color:${d.res==='+ve'?'red':'green'}">
                                    <option value="-ve" ${d.res==='-ve'?'selected':''}>-ve</option>
                                    <option value="+ve" ${d.res==='+ve'?'selected':''}>+ve</option>
                                </select>
                            </div>`;
                    });
                }

                html += `</div></div>`;
                bc.insertAdjacentHTML('beforeend', html);
            });
            
            const el = view.querySelector('.ex-list');
            exercises.forEach(e => {
                const chk = pt.ex.includes(e) ? 'checked' : '';
                const activeClass = pt.ex.includes(e) ? 'active' : '';
                el.insertAdjacentHTML('beforeend', 
                    `<div class="chk-item ${activeClass}" onclick="toggleChk(this)">
                        <input type="checkbox" value="${e}" ${chk}>
                        <span>${e}</span>
                    </div>`
                );
            });
            
            view.querySelector('.ex-free').value = pt.ex_free || "";
            cont.appendChild(view);
        });
    }

    function switchTab(i) { saveWork(); currentTab = i; renderAll(); }
    function updateTabName(i) { document.querySelectorAll('.tab-btn')[currentTab].innerText = i.value.substr(0,8) || `Pt ${currentTab+1}`; }
    function toggleStairs(sel) { sel.nextElementSibling.classList.toggle('hidden', sel.value !== 'Stairs'); }
    
    function toggleChk(div) { 
        const chk = div.querySelector('input'); 
        chk.checked = !chk.checked; 
        div.classList.toggle('active', chk.checked);
        saveWork();
    }
    
    function generateNote() {
        saveWork();
        const pt = currentPatients[currentTab];
        const line = "======================================================";
        let t = `Diagnosis: ${pt.dx || ''}\nReason for referral: ${pt.ref || ''}\n`;
        t += `Physiotherapy Home Visit\n${line}\n`;
        
        t += `History of Present Illness:\n${pt.hpi || ''}\n`;
        t += `Past Medical History:\n${pt.pmh || ''}\n`;
        t += `Medication:\n${pt.meds || ''}\n`;
        
        t += `Social History:\nLives with ${pt.soc.live || ''}\nTake cared by ${pt.soc.carer || ''}\nADL-I\n`;
        t += `Premorbid: ${pt.soc.pre || ''}\n`;
        
        let envText = `${pt.soc.note || ''}\n${pt.soc.type || ''}\n`;
        if(pt.soc.acc === 'Stairs') envText += `Stairs: ${pt.soc.stairs || '?'} steps\n`;
        else envText += `${pt.soc.acc || ''}\nNo stairs\n`;
        t += `Home Environment:\n${envText}`;
        
        let toiletText = `Toilet: ${pt.soc.wc || ''}`;
        let bathText = `Bath: ${pt.soc.bath || ''}`;
        if(pt.soc.rails) { toiletText += " (Handrails available)"; bathText += " (Handrails available)"; }
        t += `${toiletText}\n${bathText}\n`;
        
        t += `Fall History and Reason: ${pt.fall || ''}\n`;
        t += `Mental Status: ${pt.ment || ''}\n`;
        t += `Previous physiotherapy treatment received and its effects:\n${pt.prev || 'NIL'}\n`;
        
        t += `Subjective examination:\nCompliant: ${pt.assess.subj || ''}\nFunctional limitation: ${pt.assess.func || ''}\n`;
        
        t += `Objective examination:\nPatient assessed with ${pt.assess.ass_with || ''}\nGeneral condition stable\n`;
        t += `Blood Pressure ${pt.assess.bp || ''} mmHg ;Pulse ${pt.assess.hr || ''} bpm\nTOCC-ve\nBody temperature: afebrile\n`;
        t += `Observation:\n${pt.assess.obs || ''}\n`;
        
        bodyParts.forEach(bp => {
            let pText = "";
            let hasHeader = false;
            
            bp.mov.forEach(m => {
                const uid = `${bp.id}_${m}`;
                const d = pt.roms[uid];
                let val = "";
                if(d) {
                    if(d.r) val += d.r + " ";
                    if(d.q) val += "with " + d.q + " ";
                    if(d.m) val += "(" + d.m + ")";
                }
                
                // MAPPING TO FULL TEXT
                const fullMov = movMap[m] || m;
                
                if(val.trim()) {
                    if(!hasHeader) { pText += `${bp.noteTitle}\n`; hasHeader = true; }
                    pText += `${fullMov}: ${val || '-'}\n`;
                }
            });

            if(bp.tests) {
                bp.tests.forEach(test => {
                    const uid = `${bp.id}_test_${test}`;
                    const d = pt.roms[uid];
                    if(d && (d.res === '+ve' || (d.txt && d.txt.trim().length > 0))) {
                         if(!hasHeader) { pText += `${bp.noteTitle}\n`; hasHeader = true; }
                         let line = `${test}: ${d.res}`;
                         if(d.txt) line += ` (${d.txt})`;
                         pText += line + "\n";
                    }
                });
            }

            if(bp.palp) {
                bp.palp.forEach(palp => {
                    const uid = `${bp.id}_palp_${palp}`;
                    const d = pt.roms[uid];
                    if(d && (d.res === '+ve' || (d.txt && d.txt.trim().length > 0))) {
                         if(!hasHeader) { pText += `${bp.noteTitle}\n`; hasHeader = true; }
                         let line = `Tenderness (${palp}): ${d.res}`;
                         if(d.txt) line += ` (${d.txt})`;
                         pText += line + "\n";
                    }
                });
            }
            t += pText;
        });
        
        t += `Power\nUpper limb: right / left\n                   ${pt.assess.pul || ''}\n`;
        t += `Lower limb: right / left\n                   ${pt.assess.pll || ''}\n`;
        
        t += `Bed mobility: ${pt.plan.bed || ''}\nTransfer: ${pt.plan.tf || ''}\nGait: ${pt.plan.gait || ''}\n`;
        t += `Problem: ${pt.plan.prob || ''}\nShort term goal: ${pt.plan.stg || ''}\nLong term goal: ${pt.plan.ltg || ''}\n`;
        
        t += `Home exercise taught with exercise leaflet and red theraband given (5-10 repetitions/set, 2-3 sets/day):\n`;
        pt.ex.forEach(e => t += `-${e}\n`);
        
        if(pt.ex_free) {
            let lines = pt.ex_free.split('\n');
            lines.forEach(l => { if(l.trim()) t += `-${l.trim()}\n`; });
        }
        
        t += `Machine Test Done\nWarning / Instructional given and contraindication checked\nPost treatment uneventful`;

        document.getElementById('copy_target').value = t;
        document.getElementById('copy_target').select();
        document.execCommand('copy');
        alert("CMS Note Copied!");
    }

    window.toggleAc = (el) => { el.classList.toggle('active'); el.nextElementSibling.classList.toggle('show'); };
    window.sel = (el) => { el.parentElement.querySelectorAll('.range').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); };
    window.tog = (el) => { el.classList.toggle('selected'); };
</script>
</body>
</html>
